<!DOCTYPE html>
<html>

<head>
    <title>Gmail API Quickstart - Detail</title>
    <meta charset="utf-8" />
</head>

<body>
    <p>Gmail API Quickstart - Detail</p>
    <button id="authorize_button" onclick="handleAuthClick()">Authorize</button>
    <button id="signout_button" onclick="handleSignoutClick()" style="visibility: hidden;">Sign Out</button>
    <div id="email-content"></div>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const messageId = urlParams.get('message-id');

    </script>
    <script type="text/javascript">

        function loadScriptSync(src, callback) {
            var script = document.createElement('script');
            script.src = src;
            script.type = "text/javascript";
            script.async = true;
            script.defer = true;
            script.onload = callback;
            document.getElementsByTagName('body')[0].appendChild(script);
        }

        async function loadEnvironment() {
            const response = await fetch("./environment.json");
            return await response.json();
        }

        function downloadBase64Url(base64UrlString, filename) {
            const mimeType = "application/octet-stream"; // Generic type for download
            const dataURI = `data:${mimeType};base64,${base64UrlString}`; // This re-adds the type for download mechanism

            const link = document.createElement('a');
            link.href = dataURI;
            link.download = filename; // Forces download with specified filename
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        /**
         * Validates if a string is in the standard Base64 format (RFC 4648 Section 4).
         * Allows optional padding.
         */
        function isBase64(str) {
            if (typeof str !== 'string') return false;
            // Regex explanation:
            // ^(?:[A-Za-z0-9+/]{4})* : Matches zero or more full 4-character blocks
            // (?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4})?$ : Matches the final 2, 3, or 4 character block (with optional padding)
            const base64Regex = /^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4})?$/;
            return base64Regex.test(str);
        }

        /**
         * Validates if a string is in the Base64URL format (RFC 4648 Section 5).
         * Padding is optional and often removed in URLs.
         */
        function isBase64Url(str) {
            if (typeof str !== 'string') return false;
            // Regex explanation:
            // ^[A-Za-z0-9_-]*$ : Matches characters A-Z, a-z, 0-9, -, and _
            // Padding character (=) is generally omitted in base64url, but some implementations might allow it URL-encoded (%3D).
            // This regex assumes the common padding-free format.
            const base64UrlRegex = /^[A-Za-z0-9_-]*$/;
            // Additionally, check length constraint: must be a multiple of 4 if padding is considered optional, or
            // if you want to be strict with the "padding free" variant, ensure the string length % 4 is not 1 (which is invalid)
            const len = str.length;
            if (len % 4 === 1) return false;

            return base64UrlRegex.test(str);
        }

        function base64urlToBase64(base64url) {
            // Replace non-url-safe characters and add padding
            let base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
            while (base64.length % 4) {
                base64 += '=';
            }
            return base64;
        }

        function base64ToBlob(base64, mimeType) {
            const byteCharacters = atob(base64);
            const byteArrays = [];
            for (let offset = 0; offset < byteCharacters.length; offset += 1024) {
                const slice = byteCharacters.slice(offset, offset + 1024);
                const byteNumbers = new Array(slice.length);
                for (let i = 0; i < slice.length; i++) {
                    byteNumbers[i] = slice.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                byteArrays.push(byteArray);
            }
            return new Blob(byteArrays, { type: mimeType });
        }

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a); // Append link to body
            a.click(); // Trigger download
            document.body.removeChild(a); // Remove link from body
            URL.revokeObjectURL(url); // Clean up the object URL
        }

        function generateLink(base64Data, contentType, filename, size) {
            // Construct the data URI
            const linkSource = `data:${contentType};base64,${base64Data}`;
            console.log("linkSource", linkSource)
            const p = document.createElement("p");
            // Create a temporary anchor element
            const downloadLink = document.createElement("a");
            debugger
            downloadLink.onclick = function () {
                let isBase64URL = isBase64Url(base64Data);
                console.log('isBase64URL', isBase64URL);
                let base64 = isBase64URL ? base64urlToBase64(base64Data) : base64Data;
                console.log('base64', base64)
                let blob = base64ToBlob(base64, contentType);
                console.log('blob', blob)
                downloadBlob(blob, filename);

                document.getElementById('fileElem').value = base64;
            }

            // Set the href attribute to the data URI
            downloadLink.href = "#";

            // Set the download attribute with the desired filename
            // This instructs the browser to download the target instead of navigating to it
            //downloadLink.download = filename;
            downloadLink.innerHTML = filename;
            const label1 = document.createElement("label");
            label1.innerText = ` - ${size} bytes`;

            // 1. Create the form element
            const form = document.createElement('form');
            // Important: For file uploads, set method to POST and enctype to multipart/form-data
            form.method = 'POST';
            form.action = './receive.php'; // Replace with your server endpoint URL
            form.enctype = 'multipart/form-data';

            // 2. Create a label for accessibility
            const label = document.createElement('label');
            label.textContent = 'Select File: ';
            label.htmlFor = 'fileElem';

            // 3. Create the file input element (<input type="file">)
            const fileInput = document.createElement('input');
            fileInput.type = 'text'; // Defines the file-select field
            fileInput.id = 'fileElem';
            fileInput.name = 'archivo'; // Name for the form data field

            // Optional: Allow multiple files
            // fileInput.multiple = true; 

            // Optional: Accept specific file types (e.g., images)
            // fileInput.accept = 'image/*'; 

            // 4. Create the submit button element
            const submitButton = document.createElement('button');
            submitButton.type = 'submit'; // The default type for a button in a form
            submitButton.textContent = 'Upload';

            // 5. Append elements to the form
            form.appendChild(label);
            form.appendChild(fileInput);
            form.appendChild(submitButton);


            const breakWord = document.createElement("br");
            // Append the link to the body (required for Firefox) and click it
            p.appendChild(downloadLink);
            p.appendChild(label1);
            p.appendChild(form);
            p.appendChild(breakWord);
            document.getElementById('email-content').appendChild(p);
            //downloadLink.click();

            // Clean up: remove the link after the click
            //document.body.removeChild(downloadLink);
        }

        async function getMessageData() {

            body = await getMessageMetadata(messageId);
            console.log(body)
            let header = body.payload.headers.filter(header => header.name == "Subject");
            header = header.map(headerItem => `${headerItem.name} : ${headerItem.value}`);
            header = header[0];
            const p = document.createElement("p");
            p.innerText = header;
            document.getElementById('email-content').appendChild(p);
            body.payload.parts.forEach(async partItem => {
                console.log(partItem)
                if (partItem.parts) {
                    partItem.parts.forEach(async partItem2 => {
                        //console.log(partItem2.body)
                        if (partItem2.body.attachmentId) {
                            //console.log(partItem2.body.attachmentId)
                            body2 = await getMessageAttachments(messageId, partItem2.body.attachmentId);
                            let base64 = body2.data;
                            console.log(body2.data)
                            generateLink(body2.data, partItem2.mimeType, partItem2.filename, body2.size);
                        }
                    });
                } else if (partItem.body.attachmentId) {
                    body2 = await getMessageAttachments(messageId, partItem.body.attachmentId);
                    let base64 = body2.data;
                    console.log(body2.data)
                    generateLink(body2.data, partItem.mimeType, partItem.filename, body2.size);
                }

            });
        }

        // Load environment variables and logic synchronously
        loadEnvironment().then((environment) => {
            window.environment = environment;
            loadScriptSync("index.js", function () {

                const sessionInitRef = sessionInit;

                // Override the original function with a new one
                sessionInit = async function (...args) {
                    console.log(">>> Detected that sessionInit is about to run.");

                    // Call the original function with the correct context and arguments
                    sessionInitRef.apply(this, args);

                    console.log("<<< Detection logic after execution.");

                    await getMessageData();
                };

                loadScriptSync("https://apis.google.com/js/api.js", window.loadGoogleAPI);
                loadScriptSync("https://accounts.google.com/gsi/client", window.loadGoogleTokenClient);

            });

        });

    </script>
</body>

</html>